# AGENTS.md - Repository Agent Contract

> Generated by `fpf init` on 2026-01-15
> FPF Patterns: Proxy-Audit Loop, MVE Mandate, State Explicitness, Boundary Discipline Matrix

---

## 1. Language & Runtime Policy

### JavaScript/TypeScript Runtime
| Priority | Runtime | Use Case |
|----------|---------|----------|
| 1st | Deno | Scripts, tooling, TypeScript |
| 2nd | Bun | Performance-critical paths |

---

## 2. Deployment Policy

| Rule | Enforcement |
|------|-------------|
| **Pipeline-only deploys** | No manual deploys. GitHub Actions only. |
| **No prod credentials locally** | Use OIDC from GitHub Actions to cloud |
| **Environment approvals** | Required for production deployments |
| **Branch protection** | main/master require PR + CI pass |

---

## 3. Verification Policy

Every change MUST include verification:

- [ ] Unit tests for logic changes
- [ ] Integration tests for API changes
- [ ] Playwright tests for UI changes
- [ ] Manual repro steps if automated tests not feasible

Release prep is required on PRs:

- [ ] Release notes summary
- [ ] Rollout + rollback steps
- [ ] Flags/migrations (if any)

---

## 4. FPF Patterns (Required)

### 4.1 Proxy-Audit Loop (`isProxyFor`)

```yaml
U.Objective: "{define what 'useful' means for this project}"
proxies:
  - metric: "{metric_name}"
    isProxyFor: "U.Objective"
    audit_cadence: "pre-release"
    warning_threshold: "{when to re-evaluate}"
```

**Rule**: Metrics are PROXIES, not goals. Audit before each release.

### 4.2 State Explicitness (E→S→V→O Lifecycle)

Tag all work items by lifecycle stage:

| Stage | Description | Rigor Level |
|-------|-------------|-------------|
| **E**xploration | Spikes, experiments | Lightweight |
| **S**haping | Design docs, ADRs | Medium |
| **V**alidation | Tests, evidence | High |
| **O**peration | Runbooks, monitoring | Operational |

### 4.3 MVE Mandate (Minimum Viable Evidence)

Before decisions, gather evidence appropriate to stage:

| Stage | Required Evidence |
|-------|-------------------|
| Exploration | Spike + notes |
| Shaping | ADR + interface sketch |
| Validation | Tests + metrics |
| Operation | Runbook + alerts |

### 4.4 Boundary Discipline Matrix (L/A/D/E Routing)

Route changes by type to appropriate role:

| Type | Description | Primary Role |
|------|-------------|--------------|
| **L**ogic | Domain rules, business logic | Engineer |
| **A**PI | Interfaces, contracts | Architect |
| **D**ata | Storage, schema changes | Architect + Engineer |
| **E**ffects | Side effects, I/O | Observability Debugger |

### 4.5 Didactic Primacy

Keep AGENTS.md short (<200 lines). Push depth into:
- Skills (`.codex/skills/`, `.claude/skills/`)
- Role definitions (`.agents/roles.yaml`)
- ADRs (`docs/adr/`)

---

## 5. Agent Roles

See `.agents/roles.yaml` for full definitions.

| Role | Responsibility |
|------|----------------|
| Strategist | Portfolio priorities, Proxy-Audit, naming |
| Architect | Boundaries, interfaces, ADRs |
| Observability Debugger | Telemetry queries, Playwright repros |
| Release Engineer | GitHub Actions, deploy gates |
| Release Steward | Ensure PR includes release prep checklist |
| Meta-Strategist | Self-evolution, feedback aggregation |

---

## 6. MCP Tool Access

Agents have access to these MCP servers (configured in `~/.codex/config.toml`):

| Server | Purpose | Use Case |
|--------|---------|----------|
| Playwright | Browser automation | UI testing, repro bugs |
| Figma | Design context | Tokens, specs |
| Grafana Traces | Distributed tracing | Debug latency, errors |
| Sentry | Error tracking | Investigate exceptions |

---

## 7. Skills Available

### Global Skills (always loaded from `~/.codex/skills/`)
- `fpf-proxy-audit` - Execute Proxy-Audit Loop
- `fpf-state-explicitness` - E/S/V/O lifecycle tagging
- `fpf-naming` - Name Cards, lexical bias checks
- `fpf-work-artifact` - Work Records generation

### Project Skills
Check `.codex/skills/` and `.claude/skills/` for project-specific skills.

---

## 8. Self-Evolution

This agent system is **self-evolving**. See `.agents/roles.yaml` for Meta-Strategist role.

### 8.1 Feedback Collection
After significant tasks, create a FeedbackRecord (schema in `.agents/feedback-schema.yaml`):
- Document friction points
- Propose instruction improvements
- Tag by category and severity

### 8.2 Instruction Lifecycle (ESG)
```
Draft → Canary (10%) → Effective (100%) → Deprecated
```

### 8.3 Evolution Triggers
| Trigger | Condition | Action |
|---------|-----------|--------|
| Weekly Review | Every Sunday | Meta-Strategist analyzes feedback |
| Failure Spike | Success < 90% | Immediate friction analysis |
| Repeated Friction | 3+ same issues | Priority instruction fix |

---

## 9. Nested Overrides

Subdirectories may have their own `AGENTS.md` that overrides these rules:

```
/AGENTS.md                    ← This file (root contract)
├── src/ui/AGENTS.md          ← UI-specific overrides
├── src/services/AGENTS.md    ← Backend-specific overrides
└── infra/AGENTS.md           ← Infrastructure overrides
```

**Precedence**: Nearest `AGENTS.md` wins for its scope.
